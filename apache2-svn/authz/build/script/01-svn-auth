#! /bin/sh
set -e
set -x
export DEBIAN_FRONTEND=noninteractive

## install packages
packages=""
# apt-get install -y --no-install-recommends --auto-remove --purge $packages

## modify scripts
FILE=/usr/local/bin/run-apache2-svn.sh
sed -i '/exec bash/i\mkdir -p /var/lib/backup 2> /dev/null' $FILE
sed -i '/exec bash/i\chown www-data:www-data /var/lib/backup' $FILE
sed -i '/exec bash/i\echo "$SVN_BACKUP" > /var/lib/svn/backup.txt' $FILE
sed -i '/exec bash/i\service cron restart > /dev/null' $FILE

## install cron task
FILE=/etc/cron.d/svnback
echo '0 4 * * 1-6  www-data   /usr/bin/python /var/lib/site/script/backup.py inc $(cat /var/lib/svn/backup.txt)' > $FILE
echo '0 4 * * 0    www-data   /usr/bin/python /var/lib/site/script/backup.py dump $(cat /var/lib/svn/backup.txt)' >> $FILE

## install scripts
cp -r /tmp/build/site /var/lib/site
cat /var/lib/site/etc/svnauth.cron > /etc/cron.d/svnauth

